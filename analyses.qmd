---
title: "Analyse Tree Density"
format: html
editor: visual
---

## Analyses Tree Density

Intro to the ms.

## Import data

Import data from NTNU University museum: Natron. Marc did a pivot table in excel.

```{r Loadpackages, warning=FALSE}
library(tidyverse)
library(readxl)
library(DT)
```

Imported DensityAnno2023.xlsx, with 3 regions all tree taxa and 7 heightclasses

```{r}
Data <- read_excel("data/DensityAnno2023.xlsx")
```

Subset rows (20) and columns (10)

```{r}
DT::datatable(Data[1:20,1:10])
```

## Clean data

```{r}
library(dplyr)
   
#Data <- rename(Data,heightclass=`height class 50cm (categorical)` )
```

## Explore data

Check if the datafile is ok

```{r}
table(Data$Region)
```

Three regions included: total of 34911 rows

```{r}
table(Data$Year, Data$Plot)
```

Plot NW, NE, SW, SE referes to plot names in Hedmark-Akershus and corresponds to OV (NW), OH (NE), NV (SW), NH (SE) in the two other regions.

## Figures

A scatter plot and loess smoother showing the development of larger birch trees over time.

```{r}
Data %>%
  filter(Taxa == "Betula pubescens", HeightClass > 5)%>%
  ggplot(aes(x=Year,y=Quantity))+
  geom_jitter(
             size=3,
             width=0.1,
             alpha=0.1)+
  geom_smooth(method = "loess",
              se=F)+
  facet_grid(cols=vars(Treatment),
             rows=vars(Region),
             #ncol=1,
             scales = "free_y")+
  theme_bw(base_size = 12)
  
```

We can look at species differences, and at the same time reduce the amount of points by taking the mean per location and treatement.

```{r, warning=F}
Data %>%
  filter(HeightClass > 5,
         Taxa %in% c("Betula pubescens", "Picea abies", "Pinus sylvestris", "Sorbus aucuparia"))%>%
  group_by(LocalityCode, Year, Taxa, Treatment)%>%
  summarise(Quantity = mean(Quantity)) %>%
  ggplot(aes(x=Year,y=Quantity, colour=Treatment, fill=Treatment))+
  geom_jitter(
             size=3,
             width=0.1,
             alpha=0.4)+
  geom_smooth(method = "loess",
              se=F)+
  facet_wrap(.~Taxa)+
  theme_bw(base_size = 12)
```

In the figure above we see little obvious differences in birch, pine and spruce, but large differences in rowan.

Since there is auto correlation (repeated measures at the same locatins every year), we could chose to visualise this as lines arther than points.

```{r, warning=F}
Data %>%
  filter(HeightClass > 5,
         Taxa %in% c("Betula pubescens", "Picea abies", "Pinus sylvestris", "Sorbus aucuparia"))%>%
  group_by(LocalityCode, Year, Taxa, Treatment)%>%
  summarise(Quantity = mean(Quantity)) %>%
  ggplot(aes(x=Year,y=Quantity, group=LocalityCode))+
  geom_line(alpha=0.8)+
  facet_grid(rows = vars(Taxa),
             cols=vars(Treatment))+
  theme_bw(base_size = 12)
```

We could look at the same thing, but for the smalles height class

```{r, warning=F}
Data %>%
  filter(HeightClass ==1,
         Taxa %in% c("Picea abies", "Sorbus aucuparia"))%>%
  group_by(LocalityCode, Year, Taxa, Treatment)%>%
  summarise(Quantity = mean(Quantity)) %>%
  ggplot(aes(x=Year,y=Quantity, group=LocalityCode))+
  geom_line(alpha=0.8)+
  facet_grid(rows = vars(Taxa),
             cols=vars(Treatment),
             scales="free")+
  theme_bw(base_size = 12)
```

```{r, warning=F}
Data %>%
  filter(Year==2023,
         Taxa %in% c("Picea abies", "Sorbus aucuparia"))%>%
  pivot_longer(cols = Quantity) %>%
  ggplot(aes(x=Treatment,y=HeightClass))+
  geom_violin(alpha=0.8,
              fill="grey30")+
  theme_bw(base_size = 12)+
  facet_wrap(.~Taxa)
```

```{r, warning=F}
Data %>%
  filter(Year %in% c(2009, 2013, 2018, 2023),
         Taxa %in% c("Sorbus aucuparia"))%>%
  pivot_longer(cols = Quantity) %>%
  ggplot(aes(x=Treatment,y=HeightClass, fill=Treatment))+
  geom_violin(alpha=0.8,
              adjust = 3
              #fill="grey30"
              )+
  theme_bw(base_size = 12)+
  facet_wrap(.~Year, ncol=4)+
  guides(fill="none")
```

```{r}
Data %>%
  filter(Region=='SUSTHERB Telemark',EngelskNavn=='Pine' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 12)
  
```

Number of Pine at plot level (circles) in Telemark: low spread, but reduction of plots with high abundance from 2017.No temporal trends in UB

```{r}
Data %>%
  filter(Region=='SUSTHERB Telemark',EngelskNavn=='Spruce' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 12)
```

Number of Spruce at plot level (circles) in Telemark: low spread, but reduction of plots with high abundance from 2016, but more in B vs UB

```{r}
Data %>%
  filter(Region=='SUSTHERB Telemark',EngelskNavn=='Birch' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 12)
```

Number of Birch at plot level (circles) in Telemark: low spread, but reduction of plots with high abundance in B from 2013.Less temporal trends in UB

```{r}
Data %>%
  filter(Region=='SUSTHERB Telemark',EngelskNavn=='Rowan' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 12)
```

Number of Rowan at plot level (circles) in Telemark: low spread, but no reduction of plots in B and UB

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag')%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of trees at plot level (circles) in Trondelag: low spread, but reduction of plots with high abundance in B from 2013 and in UB

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Pine' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of Pine trees at plot level (circles) in Trondelag: low spread, but reduction of plots with high abundance in B and in UB from 2013

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Spruce' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of Spruce trees at plot level (circles) in Trondelag: low spread, but reduction of plots with high abundance in UB from 2013.Less temporal trends in B

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Birch' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of Birch trees at plot level (circles) in Trondelag: low spread, but no reduction of plots with high abundance in B from 2013.Increasing temporal trends in UB

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Rowan' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of rowan trees at plot level (circles) in Trondelag: low spread, but some reduction of plots with high abundance in B and UB

```{r}
Data %>%
  #filter(Region=='SUSTHERB Telemark',EngelskNavn=='Pine' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of pine trees at plot level (circles) in Telemark: low spread,

```{r}
Data %>%
  filter(EngelskNavn=='Pine' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of trees at plot level (circles) across all regions: low spread, but some reduction of plots with high abundance in B and UB from 2013

```{r}
Data %>%
  filter(EngelskNavn=='Spruce' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of spruce trees at plot level (circles) across all regions: low spread, but some reduction of plots with high abundance in B and UB

```{r}
Data %>%
  filter(EngelskNavn=='Birch' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of birch trees at plot level (circles) across all regions: low spread, no reduction of plots with high abundance in B and UB

```{r}
Data %>%
  filter(EngelskNavn=='Rowan' )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of rowan trees at plot level (circles) across all regions: low spread, no reduction of plots with high abundance in B and UB

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Pine' )%>%
  ggplot()+
  geom_point(size=3,alpha=.5,
aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Birch' )%>%
  ggplot()+
  geom_point(size=3,alpha=.5,
aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Spruce' )%>%
  ggplot()+
  geom_point(size=3,alpha=.5,
aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Rowan' )%>%
  ggplot()+
  geom_point(size=3,alpha=.5,
aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Birch',
        HeightClass=="7" )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of birch trees at plot level (circles) in Trøndelag at harvest class 7: increased in UB from 2018 and to lesser extent in B from 2019

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Spruce',
        HeightClass=="7" )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of spruce trees at plot level (circles) in Trøndelag at harvest class 7: increased in B from 2016 and to lesser extent in UB from 2019

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Rowan',
        HeightClass=="7" )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of Rowan trees at plot level (circles) in Trøndelag at harvest class 7: increased in UB from 2015. No in B

```{r}
Data %>%
  filter(EngelskNavn=='Rowan',
        HeightClass=="7" )%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Rowan',
        HeightClass=="1")%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

Number of rowan trees at plot level (circles) in Trøndelag at harvest class 1:

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Rowan',
        HeightClass=="2")%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

```{r}
Data %>%
  filter(Region=='SUSTHERB Trondelag',EngelskNavn=='Rowan',
        HeightClass=="3")%>%
  ggplot()+
  geom_violin(aes(x=factor(Year),
                 y=Quantity
                 ),
              fill = "yellow")+
  facet_wrap(.~Treatment,
             ncol=1,
             scales = "free")+
  theme_bw(base_size = 10)
```

## LMM
We will use a frquantist approach to mixed effects modelling with `lme4`. 
We have a random structure given by the samppling desig.
Our fixed structure is defined from theoretical expectations (a model set) and no model selection is done.
Effect sizes are interpreted using the estimated and the errors, simulating a normal distribution for the estimates. 
P-values are not reported.

```{r}
library(lme4)
```
We will not look at the temporal trends, but rather focus on the last year.
The last year with data is 2023, which is 15-11 years of data, depending on the region.

```{r}
Data <- Data %>%
  mutate(yearsSinceStart = case_when(
    Region == "SUSTHERB Hedmark-Akershus" ~ Year -2012,
    Region == "SUSTHERB Telemark" ~ Year -2009,
    Region == "SUSTHERB Trondelag" ~ Year -2008
  ))
```



```{r}
table(Data$yearsSinceStart, Data$Region)
```

It's a shame to cut 4 years with data, so I will just use the 2023 data for all regions.
With only three regions it is possible to interpret the regional affect and duration effect combined.

```{r}
modelData <- Data %>%
  filter(Year == 2023)
```

```{r}
pineData <- modelData %>%
  filter(Taxa == "Pinus sylvestris")

birchData <- modelData %>%
  filter(Taxa %in%c("Betula pubescens", "Betula pendula") )
```

One hypothesis is about the quantity of large trees above browsing height.
Lets define that as the height class 7 (>3m)

```{r}
birchData7 <- birchData %>%
  filter(HeightClass ==7)
```

Then we model the density of these trees as a function of treatment.
(We could look at productivity and moose density here as well!)

```{r}
model1 <- lme4::lmer(data = birchData7,
               Quantity ~ Treatment + (1|Region))
```

We can run a summary, mainly se see that the model is fitted correctly
```{r}
summary(model1)
```

Lets put the residuals into the dataframe for plotting
```{r}
birchData7$resids1 <- resid(model1)
```


```{r}
birchData7 %>%
  mutate(resid1 = resid(model1),
         fitted1 = fitted(model1)) %>%
  ggplot()+
  geom_point(aes(x = fitted1, y = resid1),
             position = position_jitter(),
             colour = "white", size=3)+
  theme_dark()
```



```{r}
qqnorm(birchData7$resids1)
qqline(birchData7$resids1)
```

Not good. 

Perhaps we should use a gamma distribution
```{r}
hist(birchData7$Quantity)
```
```{r}
model2 <- lme4::glmer(data=birchData7,
                      Quantity ~ Treatment + (1|Region),
                      family = Gamma(link="identity"))
summary(model2)
```



```{r}
plot(model2)
```

```{r}
qqnorm(resid(model2))
qqline(resid(model2))
```

The residuals are better, but not perfect. 
The link function does not affect them.
I tried log and inverse as well.

Let's try a simple log-normal model
```{r}
model3 <- lmer(data=birchData7,
               log(Quantity) ~ Treatment +(1|Region))
summary(model3)
```

```{r}
qqnorm(resid(model3))
qqline(resid(model3))
```

The log-normal model looks best I think

```{r}
stargazer::stargazer(model3, 
                     type = "text",
                     digits = 3,
                     star.cutoffs = c(0.05, 0.01, 0.001),
                     digit.separator = "")
```

Note that the gamma model gives much smaller errors than the log-normal, so the choice of model actually matters.

Here is one way to visualise the treatmehnt effect:

```{r}
birchData7 %>%
  summarise(q = sum(Quantity), .by= c(Region, LocalityName, Treatment)) %>%
  pivot_wider(names_from = Treatment,
              values_from = q,
              values_fill = 0) %>%
  mutate(effect = Unbrowsed-Browsed) %>%
  ggplot()+
  geom_dotplot(aes(x = effect, fill=Region),
               binpositions = "all",
               stackgroups = TRUE,
               method = "histodot",
               stackdir="center")+
  ggtitle("Birch > 3m")+
  geom_vline(xintercept = 0)+
  theme_bw()+
  labs(x = "Treatment effect",
       y = "Frequency of sites")
```

