---
title: "Analyse Tree Density"
format: html
editor: visual
---

## Analyses Tree Density

Intro to the ms.

## Import data

Import data from NTNU University museum: Natron. Marc did a pivot table in excel.

```{r setup, warning=FALSE}
library(tidyverse)
library(readxl)
library(DT)
library(lme4)
library(ggridges)
```

Imported DensityAnno2023.xlsx, with 3 regions all tree taxa and 7 heightclasses

```{r}
Data <- read_excel("data/DensityAnno2023.xlsx")
```

Importing productivity index. See `productivity index.qmd`.

```{r}
# read data
productivityIndex <- readRDS("data/productivityIndex.RDS")

Data <- Data %>%
  left_join(productivityIndex, by=join_by(LocalityName)) |>
  filter(
    EngelskNavn != "Empty sample",
    HeightClass >0,
    Taxa != "0-Not Determined") %>%
  mutate(
    # add tree height in cm as the central value for each height category
    height_cm = case_when(
      HeightClass == 1 ~ 25,
      HeightClass == 2 ~ 75,
      HeightClass == 3 ~ 125,
      HeightClass == 4 ~ 175,
      HeightClass == 5 ~ 225,
      HeightClass == 6 ~ 275,
      HeightClass == 7 ~ 325)
    )
```

Subset rows (20) and columns (10)

```{r}
DT::datatable(Data[1:20,1:10])
```

## Clean data

Obs - the Plot variable is used slightly differently between sites (but consistently within sites)

```{r}
Data |>
  count(Plot)


sum(is.na(Data$Plot))
```

I will just conform these.

```{r}
Data <- Data |>
  mutate(Plot = case_when(
    Plot == "NW" ~ "OV",
    Plot == "NE" ~ "OH",
    Plot == "SW" ~ "NV",
    Plot == "SE" ~ "NH",
    .default = Plot
  ))
```

```{r}
Data |>
  count(Plot)
```

Expanding the data set and adding rows for with quantity equal to zero for cases where a taxa was not found. Note that when I add a this zero, the height category and height_cm column is filled with NAs.

```{r}
Data <- Data |>
    complete( 
      Taxa,
        nesting(
        Region,
        LocalityName,
        productivityIndex,
        LocalityCode,
        Plot,
        Treatment,
        Year
        ),
      fill = list(Quantity = 0)) 

```

## Explore data

Check if the data file is ok

```{r}
table(Data$Region)
```

Three regions included: total of 34911 rows

```{r}
table(Data$Year, Data$Plot)
```

## Modelling

### Subsetting data set

We will use a frequentist approach to mixed effects modelling with `lme4`. We have a random structure given by the sampling design. Our fixed structure is defined from theoretical expectations (a model set) and no model selection is done. Effect sizes are interpreted using the estimated and the errors, simulating a normal distribution for the estimates. P-values are not reported.

We will not look at the temporal trends, but rather focus on the last year. The last year with data is 2023, which is 15-11 years of data, depending on the region.

### The Hedmark-Akershus sites were initiated at different times:

```{r}
init2007 <- c(
  "Hedmark | Maarud 1 | Winter browsing",
  "Hedmark | Maarud 2 | Winter browsing",
  "Hedmark | Maarud 3 | Winter browsing"
)

init2010 <- c(
  "Hedmark | Didrik | Winter browsing",
  "Hedmark | Halvard | Winter browsing",
  "Hedmark | Stangeskovene Aurskog | Winter browsing",
  "Hedmark | Stangeskovene Eidskog | Winter browsing",
  "Hedmark | Stig | Winter browsing"
)

init2011 <- c(
  "Hedmark | Eidskog | Winter browsing",
  "Hedmark | Fet | Winter browsing",
  "Hedmark | Kongsvinger 1 | Winter browsing",
  "Hedmark | Kongsvinger 2 | Winter browsing",
  "Hedmark | Nes 1 | Winter browsing",
  "Hedmark | Nes 2 | Winter browsing",
  "Hedmark | SOrum | Winter browsing"
)
```

```{r}
Data <- Data %>%
  mutate(yearsSinceStart = case_when(
    Region == "SUSTHERB Telemark" ~ Year -2009,
    Region == "SUSTHERB Trondelag" ~ Year -2008,
    LocalityName %in% init2007 ~ Year - 2007,
    LocalityName %in% init2010 ~ Year -2010,
    LocalityName %in% init2011 ~ Year - 2011
  ))
```

```{r}
table(Data$yearsSinceStart, Data$Region)
```

It's a shame to cut 4 years with data, so I will just use the 2023 data for all regions. With only three regions it is possible to interpret the regional affect and duration effect combined.

Four localities were omitted due to disturbances

```{r}
modelData <- Data %>%
  filter(
    Year == 2023,
    !LocalityName %in% c(
      "Hedmark | Nes 1 | Winter browsing",
      "TrOndelag | Selbu_Fl | Winter browsing",
      "TrOndelag | Malvik | Winter browsing",
      "TrOndelag | Hi_tydal | Winter browsing"
    )
  )

# same as:
# modelData <- filter(Data, Year == 2023)

# %>% kalles 'pipe'. Kan ogsÃ¥ skrives |>
```
